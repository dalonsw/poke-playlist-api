<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Time Pok√©mon ‚Äî REST</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- √çcone opcional do Pok√©mon -->
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png">

  <style>
    .pokemon-card {
      background: #ffffffee;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 15px #0001;
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 12px;
      width: 100%;
      box-sizing: border-box;
      min-height: 96px;
      justify-content: center;
    }
    .sprite {
      height: 72px;
      width: 72px;
      object-fit: contain;
    }
    #teamList, #playlistResult {
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr;
      align-items: start;
      justify-items: stretch;
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
    }
    .type-normal { background-color: #A8A77A !important; color: #000; }
    .type-fire { background-color: #EE8130 !important; color: #fff; }
    .type-water { background-color: #6390F0 !important; color: #fff; }
    .type-electric { background-color: #F7D02C !important; color: #000; }
    .type-grass { background-color: #7AC74C !important; color: #000; }
    .type-ice { background-color: #96D9D6 !important; color: #000; }
    .type-fighting { background-color: #C22E28 !important; color: #fff; }
    .type-poison { background-color: #A33EA1 !important; color: #fff; }
    .type-ground { background-color: #E2BF65 !important; color: #000; }
    .type-flying { background-color: #A98FF3 !important; color: #000; }
    .type-psychic { background-color: #F95587 !important; color: #fff; }
    .type-bug { background-color: #A6B91A !important; color: #000; }
    .type-rock { background-color: #B6A136 !important; color: #000; }
    .type-ghost { background-color: #735797 !important; color: #fff; }
    .type-dragon { background-color: #6F35FC !important; color: #fff; }
    .type-dark { background-color: #705746 !important; color: #fff; }
    .type-steel { background-color: #B7B7CE !important; color: #000; }
    .type-fairy { background-color: #D685AD !important; color: #000; }
    @media (min-width: 576px) {
      #teamList, #playlistResult {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (min-width: 992px) {
      #teamList, #playlistResult {
        grid-template-columns: repeat(3, 1fr);
      }
    }
  </style>
</head>

<body class="bg-light">

  <div class="container py-4">
    <h1 class="mb-4">üì¶ Time Pok√©mon ‚Äî Cliente REST</h1>
    <a href="/" style="margin: 10px;">Retornar ao In√≠cio</a>

    <!-- Status -->
    <div id="status" class="alert alert-info">Aguardando...</div>
    <div class="card mb-4">
      <!-- Ver time -->
      <div class="card-body">
        <h4 class="card-title">Ver Time (GET /team)</h4>
        <button id="btnGet" class="btn btn-primary mt-2">Carregar Time</button>
        <div id="teamList" class="mt-3"></div>
      </div>
      <!-- Ver playlist -->
      <div class="card-body">
        <h4 class="card-title">Ver Playlist do Time (GET /team/playlist)</h4>
        <button id="btnGetPlaylist" class="btn btn-secondary mt-2">Carregar Playlist</button>
        <div id="playlistResult" class="mt-3"></div>
      </div>
    </div>


    <!-- Adicionar -->
    <div class="card mb-4">
      <div class="card-body">
        <h4 class="card-title">Adicionar Pok√©mon (POST /team)</h4>
        <input id="addIdentifier" class="form-control mb-2" placeholder="Nome ou n√∫mero">
        <button id="btnAdd" class="btn btn-success">Adicionar</button>
      </div>
    </div>

    <!-- Atualizar -->
    <div class="card mb-4">
      <div class="card-body">
        <h4 class="card-title">Atualizar Pok√©mon (PUT /team)</h4>
        <input id="updateIdentifier" class="form-control mb-2" placeholder="Identifier atual (nome ou id)">
        <input id="updateNewIdentifier" class="form-control mb-2" placeholder="Novo identifier">
        <button id="btnUpdate" class="btn btn-warning">Atualizar</button>
      </div>
    </div>

    <!-- Deletar -->
    <div class="card mb-5">
      <div class="card-body">
        <h4 class="card-title">Excluir Pok√©mon (DELETE /team/:identifier)</h4>
        <input id="deleteIdentifier" class="form-control mb-2" placeholder="Nome ou n√∫mero">
        <button id="btnDelete" class="btn btn-danger">Excluir</button>
      </div>
    </div>

    <!-- Logs -->
    <div class="card mb-4">
      <div class="card-body">
        <h4 class="card-title">Logs</h4>
        <pre id="logs" style="height: 200px; overflow-y: scroll; background: #f8f9fa; padding: 10px; border: 1px solid #ddd;"></pre>
      </div>
    </div>

  </div>

  <script>
    const statusEl = document.getElementById("status");
    const teamList = document.getElementById("teamList");

    function setStatus(msg, type = "info") {
      statusEl.className = `alert alert-${type}`;
      statusEl.textContent = msg;
    }

    function renderTeam(team) {
      teamList.innerHTML = "";
      if (!team || team.length === 0) {
        teamList.innerHTML = "<p class='text-muted'>Time vazio.</p>";
        return;
      }

      team.forEach(p => {
        const name = p.pokemon.name.charAt(0).toUpperCase() + p.pokemon.name.slice(1);
        const types = p.pokemon.types;
        const card = document.createElement("div");
        card.className = "pokemon-card";

        const img = document.createElement("img");
        img.className = "sprite";
        img.src = p.pokemon.sprite;
        img.alt = name;

        const info = document.createElement("div");
        info.innerHTML += `
          <strong>${name}</strong> (#${p.pokemon.id})<br>
        `;
        types.forEach(type => {
          const span = document.createElement('span');
          span.className = "badge bg-secondary me-1 " + `type-${type}`;
          span.textContent = type.charAt(0).toUpperCase() + type.slice(1);
          info.appendChild(span);
        });

        card.appendChild(img);
        card.appendChild(info);
        teamList.appendChild(card);
      });
    }

    function renderPlaylist(team) {
      const playlistResult = document.getElementById("playlistResult");
      playlistResult.innerHTML = "";
      if (!team || team.length === 0) {
        playlistResult.innerHTML = "<p class='text-muted'>Nenhuma m√∫sica na playlist.</p>";
        return;
      }

      // Junta todas as m√∫sicas do time e remove duplicadas
      const seen = new Set();
      const combined = [];

      team.forEach(p => {
        const playlist = p.playlist || [];
        playlist.forEach(track => {
          if (!track) return;

          const name = (track.name || "").toString().trim();
          const url = (track.url || "").toString().trim();
          let artists = "";
          if (Array.isArray(track.artists)) artists = track.artists.join(", ");
          else if (track.artists) artists = track.artists.toString();

          // chave para deduplica√ß√£o: preferir URL quando dispon√≠vel, sen√£o nome+artistas
          const key = url ? `url:${url.toLowerCase()}` : `meta:${(name + "::" + artists).toLowerCase()}`;

          if (!seen.has(key)) {
            seen.add(key);
            combined.push({ name, artists, url });
          }
        });
      });

      if (combined.length === 0) {
        playlistResult.innerHTML = "<p class='text-muted'>Nenhuma m√∫sica na playlist.</p>";
        return;
      }

      const plDiv = document.createElement("div");
      plDiv.className = "mb-4";

      const title = document.createElement("h5");
      title.textContent = `Playlist do time (${combined.length} ${combined.length === 1 ? "m√∫sica" : "m√∫sicas"})`;
      plDiv.appendChild(title);

      const ul = document.createElement("ul");
      ul.className = "list-group";

      combined.forEach(track => {
        const li = document.createElement("li");
        li.className = "list-group-item";
        const artistsText = track.artists ? ` - ${track.artists}` : "";
        const href = track.url || "#";
        li.innerHTML = `<a href="${href}" target="_blank" rel="noopener noreferrer">${track.name || "Untitled"}${artistsText}</a>`;
        ul.appendChild(li);
      });

      plDiv.appendChild(ul);
      playlistResult.appendChild(plDiv);
    }

    // Load Team Playlist
    document.getElementById("btnGetPlaylist").onclick = async () => {
      try {
        setStatus("Carregando playlist do time...");
        const res = await fetch("/pokemon/team");
        const data = await res.json();
        console.log(data.team);
        renderPlaylist(data.team);
        setStatus("Playlist carregada!", "success");
      } catch {
        setStatus("Erro ao carregar playlist.", "danger");
      }
    };

    // GET /team
    document.getElementById("btnGet").onclick = async () => {
      try {
        setStatus("Carregando time...");
        const res = await fetch("/pokemon/team");
        const data = await res.json();
        renderTeam(data.team);
        setStatus("Time carregado!", "success");
      } catch {
        setStatus("Erro ao carregar time.", "danger");
      }
    };

    // POST /team
    document.getElementById("btnAdd").onclick = async () => {
      const identifier = document.getElementById("addIdentifier").value.trim();
      if (!identifier) return setStatus("Informe um identifier!", "warning");

      try {
        setStatus("Adicionando...");
        const res = await fetch("/pokemon/team", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ identifier })
        });
        const data = await res.json();
        if (res.ok) {
          renderTeam(data.team);
          setStatus("Pok√©mon adicionado!", "success");
        } else {
          setStatus(data.error, "danger");
        }
      } catch {
        setStatus("Erro no POST.", "danger");
      }
    };

    // PUT /team
    document.getElementById("btnUpdate").onclick = async () => {
      const identifier = document.getElementById("updateIdentifier").value.trim();
      const newIdentifier = document.getElementById("updateNewIdentifier").value.trim();

      if (!identifier || !newIdentifier)
        return setStatus("Informe ambos identifiers!", "warning");

      try {
        setStatus("Atualizando...");
        const res = await fetch("/pokemon/team", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ identifier, newIdentifier })
        });
        const data = await res.json();
        if (res.ok) {
          renderTeam(data.team);
          setStatus("Pok√©mon atualizado!", "success");
        } else {
          setStatus(data.error, "danger");
        }
      } catch {
        setStatus("Erro no PUT.", "danger");
      }
    };

    // DELETE /team/:identifier
    document.getElementById("btnDelete").onclick = async () => {
      const identifier = document.getElementById("deleteIdentifier").value.trim();
      if (!identifier) return setStatus("Informe um identifier!", "warning");

      try {
        setStatus("Deletando...");
        const res = await fetch(`/pokemon/team/${identifier}`, { method: "DELETE" });
        const data = await res.json();
        if (res.ok) {
          renderTeam(data.team);
          setStatus("Pok√©mon removido!", "success");
        } else {
          setStatus(data.error, "danger");
        }
      } catch {
        setStatus("Erro no DELETE.", "danger");
      }
    };

  // Logging middleware
  const logsEl = document.getElementById("logs");
  const originalFetch = window.fetch;
  window.fetch = async (...args) => {
    const start = Date.now();
    try {
      const response = await originalFetch(...args);
      const duration = Date.now() - start;
      const logEntry = `[${new Date().toISOString()}] ${args[0]} - ${response.status} (${duration}ms) \n`;
      logsEl.textContent += logEntry;
      logsEl.scrollTop = logsEl.scrollHeight;
      return response;
    } catch (error) {
      const duration = Date.now() - start;
      const logEntry = `[${new Date().toISOString()}] ${args[0]} - ERROR (${duration}ms)\n`;
      logsEl.textContent += logEntry;
      logsEl.scrollTop = logsEl.scrollHeight;
      throw error;
    }
  };

  </script>

</body>
</html>
